{% extends 'base.html' %}
{% block title %}Analytics Dashboard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3>Analytics Dashboard</h3>
    <div>
        <span class="badge bg-info">Real-time Data</span>
    </div>
</div>

<!-- Kartu Statistik -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="card shadow-sm text-center h-100">
            <div class="card-body">
                <i class="bi bi-people-fill text-primary" style="font-size: 3rem;"></i>
                <h2 class="mt-3">{{ total_patients }}</h2>
                <p class="text-muted mb-0">Total Pasien</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card shadow-sm text-center h-100">
            <div class="card-body">
                <i class="bi bi-person-badge-fill text-success" style="font-size: 3rem;"></i>
                <h2 class="mt-3">{{ total_doctors }}</h2>
                <p class="text-muted mb-0">Total Dokter</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card shadow-sm text-center h-100">
            <div class="card-body">
                <i class="bi bi-clipboard2-pulse-fill text-info" style="font-size: 3rem;"></i>
                <h2 class="mt-3">{{ total_visits }}</h2>
                <p class="text-muted mb-0">Total Kunjungan</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card shadow-sm text-center h-100">
            <div class="card-body">
                <i class="bi bi-currency-dollar text-warning" style="font-size: 3rem;"></i>
                <h2 class="mt-3">Rp {{ "{:,.0f}".format(this_month_revenue) }}</h2>
                <p class="text-muted mb-0">Pendapatan Bulan Ini</p>
            </div>
        </div>
    </div>
</div>

<!-- Alert untuk Aksi Cepat -->
<div class="row g-3 mb-4">
    {% if pending_appointments > 0 %}
    <div class="col-md-6">
        <div class="alert alert-warning d-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <div>
                <strong>{{ pending_appointments }}</strong> permintaan konsultasi menunggu persetujuan.
                <a href="{{ url_for('manage_appointments') }}" class="alert-link ms-2">Tinjau Sekarang →</a>
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if unpaid_bills > 0 %}
    <div class="col-md-6">
        <div class="alert alert-danger d-flex align-items-center">
            <i class="bi bi-cash-stack me-2"></i>
            <div>
                <strong>{{ unpaid_bills }}</strong> tagihan belum diselesaikan.
                <a href="{{ url_for('manage_pembayaran') }}" class="alert-link ms-2">Lihat Tagihan →</a>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Grafik -->
<div class="row g-4">
    <!-- Grafik Tren Kunjungan -->
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header fw-bold">
                <i class="bi bi-graph-up"></i> Tren Kunjungan (7 Hari Terakhir)
            </div>
            <div class="card-body">
                <canvas id="visitsChart" height="80"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Grafik Status Pembayaran -->
    <div class="col-lg-4">
        <div class="card shadow-sm">
            <div class="card-header fw-bold">
                <i class="bi bi-pie-chart-fill"></i> Status Pembayaran
            </div>
            <div class="card-body">
                <canvas id="paymentChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Grafik Pendapatan Bulanan -->
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header fw-bold">
                <i class="bi bi-bar-chart-fill"></i> Pendapatan Bulanan (6 Bulan)
            </div>
            <div class="card-body">
                <canvas id="revenueChart" height="80"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Grafik Top Dokter -->
    <div class="col-lg-4">
        <div class="card shadow-sm">
            <div class="card-header fw-bold">
                <i class="bi bi-trophy-fill"></i> Top 5 Dokter
            </div>
            <div class="card-body">
                <canvas id="topDoctorsChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// Fungsi helper untuk fetch data
async function fetchChartData(url) {
    const response = await fetch(url);
    return await response.json();
}

// Grafik Tren Kunjungan
fetchChartData("{{ url_for('api_visits_trend') }}").then(data => {
    new Chart(document.getElementById('visitsChart'), {
        type: 'line',
        data: data,
        options: {
            responsive: true,
            plugins: {
                legend: { display: true }
            },
            scales: {
                y: { beginAtZero: true, ticks: { stepSize: 1 } }
            }
        }
    });
});

// Grafik Status Pembayaran
fetchChartData("{{ url_for('api_payment_status') }}").then(data => {
    new Chart(document.getElementById('paymentChart'), {
        type: 'doughnut',
        data: data,
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
});

// Grafik Pendapatan Bulanan
fetchChartData("{{ url_for('api_revenue_monthly') }}").then(data => {
    new Chart(document.getElementById('revenueChart'), {
        type: 'bar',
        data: data,
        options: {
            responsive: true,
            plugins: {
                legend: { display: true }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
});

// Grafik Top Dokter
fetchChartData("{{ url_for('api_top_doctors') }}").then(data => {
    new Chart(document.getElementById('topDoctorsChart'), {
        type: 'bar',
        data: data,
        options: {
            indexAxis: 'y',
            responsive: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: { beginAtZero: true, ticks: { stepSize: 1 } }
            }
        }
    });
});
</script>
{% endblock %}