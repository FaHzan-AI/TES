{% extends 'base_blank.html' %}
{% block title %}Terlalu Banyak Permintaan{% endblock %}

{% block form_title %}‚è≥ Mohon Tunggu Sebentar{% endblock %}

{% block form_content %}
<div class="text-center">
    <i class="bi bi-hourglass-split" style="font-size: 5rem; color: #ffc107;"></i>
    <h3 class="mt-4">Terlalu Banyak Permintaan</h3>
    <p class="text-muted">
        {{ description or 'Anda telah mencapai batas maksimal percobaan.' }}
    </p>
    
    <div class="alert alert-warning text-start">
        <h6><i class="bi bi-info-circle"></i> Mengapa ini terjadi?</h6>
        <p class="mb-0">
            Untuk keamanan, kami membatasi jumlah permintaan yang dapat dilakukan dalam waktu tertentu:
        </p>
        <ul class="mt-2 mb-0">
            <li><strong>Login:</strong> Maksimal 10 percobaan per 5 menit</li>
            <li><strong>Reset Password:</strong> Maksimal 5 permintaan per jam</li>
            <li><strong>Registrasi:</strong> Maksimal 15 akun per jam</li>
        </ul>
    </div>
    
    <!-- Countdown Timer dengan Progress Bar -->
    <div class="alert alert-info">
        <div class="d-flex align-items-center justify-content-center mb-3">
            <i class="bi bi-clock-history me-2" style="font-size: 1.5rem;"></i>
            <div>
                <strong>Silakan coba lagi dalam:</strong>
                <div id="countdown" class="fs-3 fw-bold text-primary mt-1">
                    {{ retry_after }}
                </div>
            </div>
        </div>
        
        <!-- Progress Bar -->
        <div class="progress" style="height: 10px;">
            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                 role="progressbar" style="width: 100%"></div>
        </div>
        
        <small class="text-muted mt-2 d-block">
            <i class="bi bi-lightbulb"></i> Halaman akan refresh otomatis setelah waktu habis
        </small>
    </div>
    
    <a href="{{ url_for('dashboard') if current_user.is_authenticated else url_for('login') }}" 
       class="btn btn-primary" id="backBtn">
        <i class="bi bi-house-door-fill"></i> Kembali ke Beranda
    </a>
</div>

<script>
// Parse retry time dari string "X menit" atau "X detik"
const retryText = '{{ retry_after }}';
let totalSeconds = 0;

// Ekstrak angka dari text
const match = retryText.match(/(\d+)/);
if (match) {
    const value = parseInt(match[1]);
    
    // Cek apakah menit atau detik
    if (retryText.includes('menit')) {
        totalSeconds = value * 60;
    } else if (retryText.includes('jam')) {
        totalSeconds = value * 3600;
    } else {
        totalSeconds = value; // Asumsi detik
    }
}

// Fallback jika parsing gagal
if (totalSeconds === 0 || isNaN(totalSeconds)) {
    totalSeconds = 60;
}

const originalSeconds = totalSeconds;
const countdownElement = document.getElementById('countdown');
const progressBar = document.getElementById('progressBar');
const backBtn = document.getElementById('backBtn');

// Fungsi format waktu
function formatTime(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    if (hours > 0) {
        return `${hours} jam ${minutes} menit ${secs} detik`;
    } else if (minutes > 0) {
        return `${minutes} menit ${secs} detik`;
    } else {
        return `${secs} detik`;
    }
}

// Update countdown setiap detik
const countdown = setInterval(() => {
    totalSeconds--;
    
    // Update text countdown
    countdownElement.textContent = formatTime(totalSeconds);
    
    // Update progress bar
    const percentage = (totalSeconds / originalSeconds) * 100;
    progressBar.style.width = percentage + '%';
    
    // Update button text
    backBtn.innerHTML = `<i class="bi bi-arrow-clockwise"></i> Redirect otomatis dalam ${totalSeconds}s...`;
    
    // Ubah warna progress bar sesuai waktu tersisa
    if (percentage > 50) {
        progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-primary';
    } else if (percentage > 25) {
        progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-warning';
    } else {
        progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-danger';
    }
    
    // Jika waktu habis, redirect
    if (totalSeconds <= 0) {
        clearInterval(countdown);
        countdownElement.textContent = '0 detik';
        backBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Redirecting...';
        
        // Redirect setelah 1 detik
        setTimeout(() => {
            window.location.href = backBtn.href;
        }, 1000);
    }
}, 1000);

// Update button saat diklik manual (stop countdown)
backBtn.addEventListener('click', () => {
    clearInterval(countdown);
});
</script>

<style>
/* Animasi untuk countdown */
#countdown {
    animation: pulse 1s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

/* Hover effect untuk button */
#backBtn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

/* Progress bar styling */
.progress {
    box-shadow: inset 0 1px 2px rgba(0,0,0,.1);
}
</style>
{% endblock %}